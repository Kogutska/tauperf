#!/usr/bin/env python

import os
import numpy as np
from h5py import File

from tauperf import log; log = log['/tau-image']
from tauperf.imaging import process_taus



if __name__ == '__main__':
    from argparse import ArgumentParser
    parser = ArgumentParser()
    parser.add_argument(
        '--cal-layer', default=None, choices=[None, 1, 2], type=int, 
        help='select layer for the image selection')
    parser.add_argument(
        '--do-plot', default=False, action='store_true',
        help='make plots of the input images')

    args = parser.parse_args()

    cal_layer = args.cal_layer

    h5_filename = os.path.join(
        os.getenv('DATA_AREA'), 'tauid_ntuples', 'v6', 'output_210files.h5')
    log.info('open h5 file {0}'.format(h5_filename))
    
    h5file = File(h5_filename, mode='r')
    rec_1p0n = h5file.get('rec_1p0n')
    rec_1p1n = h5file.get('rec_1p1n')
    rec_1p2n = h5file.get('rec_1p2n')


    log.info('process 1p0n: {0}'.format(len(rec_1p0n)))
    log.info('')
    tau_1p0n_images = process_taus(rec_1p0n, cal_layer=cal_layer, do_plot=args.do_plot, suffix='1p0n')
    log.info('')

    log.info('process 1p1n: {0}'.format(len(rec_1p1n)))
    log.info('')
    tau_1p1n_images = process_taus(rec_1p1n, cal_layer=cal_layer, suffix='1p1n')
    log.info('')

    log.info('process 1p2n: {0}'.format(len(rec_1p2n)))
    log.info('')
    tau_1p2n_images = process_taus(rec_1p1n, cal_layer=cal_layer, suffix='1p2n')
    log.info('')


    log.info('save images ...')
    dir_name = os.path.dirname(h5_filename)
    if cal_layer is not None:
        np.save(os.path.join(dir_name, 'images_S{0}_1p0n.npy'.format(cal_layer)), tau_1p0n_images)
        np.save(os.path.join(dir_name, 'images_S{0}_1p1n.npy'.format(cal_layer)), tau_1p1n_images)
        np.save(os.path.join(dir_name, 'images_S{0}_1p2n.npy'.format(cal_layer)), tau_1p2n_images)

    else:
        tau_1p0n_images_s1 = [im[0] for im in tau_1p0n_images]
        tau_1p0n_images_s2 = [im[1] for im in tau_1p0n_images]
        tau_1p0n_images_s3 = [im[2] for im in tau_1p0n_images]

        tau_1p1n_images_s1 = [im[0] for im in tau_1p1n_images]
        tau_1p1n_images_s2 = [im[1] for im in tau_1p1n_images]
        tau_1p1n_images_s3 = [im[2] for im in tau_1p1n_images]

        tau_1p2n_images_s1 = [im[0] for im in tau_1p2n_images]
        tau_1p2n_images_s2 = [im[1] for im in tau_1p2n_images]
        tau_1p2n_images_s3 = [im[2] for im in tau_1p2n_images]

        np.save(os.path.join(dir_name, 'images_S1_1p0n.npy'), tau_1p0n_images_s1)
        np.save(os.path.join(dir_name, 'images_S1_1p1n.npy'), tau_1p1n_images_s1)
        np.save(os.path.join(dir_name, 'images_S1_1p2n.npy'), tau_1p2n_images_s1)

        np.save(os.path.join(dir_name, 'images_S2_1p0n.npy'), tau_1p0n_images_s2)
        np.save(os.path.join(dir_name, 'images_S2_1p1n.npy'), tau_1p1n_images_s2)
        np.save(os.path.join(dir_name, 'images_S2_1p2n.npy'), tau_1p2n_images_s2)

        np.save(os.path.join(dir_name, 'images_S3_1p0n.npy'), tau_1p0n_images_s3)
        np.save(os.path.join(dir_name, 'images_S3_1p1n.npy'), tau_1p1n_images_s3)
        np.save(os.path.join(dir_name, 'images_S3_1p2n.npy'), tau_1p2n_images_s3)


